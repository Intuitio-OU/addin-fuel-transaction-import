"use strict";geotab.addin.importFuelTransactions=function(){var y,r,c,o,a,i,d,s,u,l,m,f,p,N,g,h,C,v,E,b,L,w=function(e){e?(o.removeAttribute("disabled"),A(!1)):o.setAttribute("disabled","disabled")},A=function(e){e?a.removeAttribute("disabled"):(a.setAttribute("disabled","disabled"),S(!1),U())},S=function(e){e?d.removeAttribute("disabled"):d.setAttribute("disabled","disabled")},P=function(e){e?c.removeAttribute("disabled"):c.setAttribute("disabled","disabled")},D=function(e,t){p.style.display="none",N.style.display="none",g.style.display="none",e&&(e.querySelector("span").textContent=t,e.style.display="block")},U=function(){for(;d.firstChild;)d.removeChild(d.firstChild)},n=function(){for(m.style.display="none",f.style.display="block";l.firstChild;)l.removeChild(l.firstChild);E=[]},I=function(){n(),U(),w(!1),A(!1)},T=function(){var r,o=0,a=0,i=d.options[d.selectedIndex].value,s=function(r,o){var a=document.createElement("TR");return Object.keys(r).forEach(function(e){if("sourceData"!==e&&"fleet"!==e){var t,n=document.createElement(o?"TH":"TD");n.textContent=o?{vehicleIdentificationNumber:"VIN",description:"Description",serialNumber:"Device Serial Number",licencePlate:"Licence Plate",comments:"Comment",dateTime:"Date (UTC)",volume:"Volume Added (litres)",odometer:"Odometer (km)",cost:"Cost",currencyCode:"Currency",location:"Location (lon,lat)",provider:"File Provider",driverName:"Driver Name",productType:"Product Type"}[t=e]||t:JSON.stringify(r[e]),o||n.setAttribute("data-th",e),a.appendChild(n)}}),a};for(m.style.display="none",f.style.display="block";l.firstChild;)l.removeChild(l.firstChild);r=document.createElement("TBODY"),E.forEach(function(e,t){var n;0===t&&((n=document.createElement("THEAD")).appendChild(s(e,!0)),l.appendChild(n)),i&&e.fleet!==i||(a++,o<10&&(o++,r.appendChild(s(e))))}),v.textContent=(10===o?"top ":"")+o+"/"+a,l.appendChild(r),m.style.display="block",f.style.display="none"},O=function(){return window.location.protocol+"//"+window.location.hostname+"/apiv1"},e=function(e){var t;(t=e.target.files?e.target.files[0]:{name:c.value.substring(c.value.lastIndexOf("\\")+1,c.length)})&&(u.value=t.name,w(!0),n()),D()},k=function(e,t,n,r,o,a,i,s,c,u,l,d,m,f,p){return{vehicleIdentificationNumber:e||"",description:t||"",serialNumber:n||"",licencePlate:r||"",comments:o||"",dateTime:a,volume:i,odometer:s,cost:c,currencyCode:u,location:l,provider:d,driverName:m,sourceData:f,productType:p}},B=function(){var m=new RegExp(" ","g"),s=0,c=2,u=3,l=1e3,f=function(e){var t=e.length;return 0<t&&'"'===e[0]&&(e=e.substring(1,e.length),0<--t&&'"'===e[t-1]&&(e=e.substring(0,e.length-1))),"(null)"===e?"":e.trim()},p=function(e){var t=parseFloat(e);return isNaN(t)?0:t},g=function(e){var t,n,r,o,a=new Date(e);return-1<e.indexOf("T")?a.toISOString():(t=new Date(Date.UTC(a.getFullYear(),a.getMonth(),a.getDate(),a.getHours(),a.getMinutes(),a.getMilliseconds())),isNaN(t.getTime())?(n=p(e),r=new Date(Date.UTC(1899,11,30)),o=new Date,o.setTime(864e5*n+Date.parse(r)),o).toISOString():t.toISOString())},h=function(e){return e/.62137},C=function(e){return 3.785*e},d=function(o,t){return new Promise(function(e){var r=[];return t.forEach(function(t){var e,n={};Object.keys(o).forEach(function(e){n[o[e].replace(m,"")]=t[e]}),t.ColumnN&&((e=new k(f(t.ColumnJ),f(t.ColumnI),"",f(t.ColumnG),"",g(f(t.ColumnAK)),C(p(f(t.ColumnN))),h(p(f(t.ColumnAH))),p(f(t.ColumnO)),"USD",{x:p(f(t.ColumnAM)),y:p(f(t.ColumnAL))},"Wex",(f(t.ColumnU)+" "+f(t.ColumnV)+" "+f(t.ColumnT)).trim(),JSON.stringify(n),function(e){switch(parseInt(e,10)||0){case 21:case 22:case 23:case 24:case 25:case 26:case 27:case 28:case 29:case 30:case 31:case 32:case 33:case 34:case 35:case 36:case 37:case 38:case 39:case 41:case 42:case 43:case 44:case 45:case 46:case 47:case 49:case 50:case 52:case 53:case 54:case 55:case 56:case 57:case 58:case 59:case 60:case 62:case 63:case 64:case 65:case 66:case 67:case 68:case 70:case 71:case 72:case 73:case 74:case 79:case 80:case 81:case 82:case 83:case 84:case 85:case 90:return"NonFuel";case 3:case 7:case 12:case 15:return"Regular";case 4:case 6:case 8:case 13:case 14:case 16:case 17:case 20:return"Premium";case 2:case 9:return"Diesel";case 1:return"E85";case 11:return"CNG";case 10:return"LPG";default:return"Unknown"}}(f(t.ColumnQ)))).fleet=f(t.ColumnA),r.push(e))}),e(r)})},v=function(l,d){return e=L.split("."),1606<=parseInt(e[2],10)?new Promise(function(e,i){var r=[],a={},o=[],t=new Promise(function(e){e()}),s="Parsing: converting addresses to coordinates... ",c=function(e,t,o,a){return function(r){return new Promise(function(n){y.call(e,t,function(e){var t=r.concat(e);D(N,o+t.length+"/"+a),n(t)},i)})}},n=function(r){var o=[];return r.addresses.forEach(function(e,t){var n=r.coordinates[t];n?a[e].coordinates=n:o.push(e)}),o},u=function(e,t){return t?moment.tz(e.replace("T"," ").replace("Z",""),t).toISOString():e};d.forEach(function(t){var e,n={};Object.keys(l).forEach(function(e){n[l[e].replace(m,"")]=t[e]}),t.ColumnS?((e=new k("",f(t.ColumnC),"","","",g((p(t.ColumnD)+p(t.ColumnE)).toFixed(15)),C(p(t.ColumnS)),h(p(t.ColumnO)),p(t.ColumnAA),"USD",null,"WexCustomer",f(t.ColumnL),JSON.stringify(n),function(e){switch(e){case"UNa":case"UNb":case"UNc":case"UNL":case"UNLEADED":case"UNLALC57":case"UNLALC10":case"UNLALC77":return"Regular";case"SUP":case"UN+":case"U+c":case"U+a":case"SUa":case"U+b":case"SUb":case"SUc":case"SUPER UN":case"UNL PLUS":case"UN+ALC57":case"UN+ALC10":case"SUPALC10":case"UN+ALC77":case"SUPALC77":case"SUPALC57":case"PREMIUM":case"UN+EADED PLUS":case"SUPER UNLEADED":return"Premium";case"DIESEL":case"PREM DSL":case"DSL":case"DS+":case"DSLDIESEL":return"Diesel";case"ETHANL85":case"E85":case"E85ETHANOL85":return"E85";case"CNG":return"CNG";case"PRO":case"PROPANE":return"LPG";default:return"Unknown"}}(f(t.ColumnR)))).address=f(t.ColumnH)+", "+f(t.ColumnI)+", "+f(t.ColumnJ)+", "+f(t.ColumnK),a[e.address]={coordinates:null,timezone:null},e.fleet=f(b),r.push(e)):console.log("Skipped row")}),o=Object.keys(a),t.then(function(){var e,n=new Promise(function(e){e([])});for(D(N,s),e=0;e<o.length;e+=100)n=n.then(c("GetCoordinates",{addresses:o.slice(e,e+100)},s,o.length));return new Promise(function(t){n.then(function(e){t({addresses:o,coordinates:e})})})}).then(n).then(function(n){var e,r=new Promise(function(e){e([])}),t=function(e){var t=e.split(",");return t.slice(1,t.length).join(",")};for(e=0;e<n.length;e+=100)r=r.then(c("GetCoordinates",{addresses:n.slice(e,e+100).map(t)}));return new Promise(function(t){r.then(function(e){t({addresses:n,coordinates:e})})})}).then(n).then(function(){var e,n=(new Date).toISOString(),t=new Promise(function(e){e([])}),r=function(e){var t=a[e].coordinates;return{x:t.x,y:t.y,dateTime:n}};for(D(N,s),e=0;e<o.length;e+=100)t=t.then(c("GetCoordinateTimeZones",{coordinates:o.slice(e,e+100).map(r)},"Parsing: finding timezone of coordinates... ",o.length));return t}).then(function(n){o.forEach(function(e,t){a[e].timezone=n[t]})}).then(function(){r.forEach(function(e){var t=a[e.address];!t.coordinates||0===t.coordinates.x&&0===t.coordinates.y?console.log("Invalid coordinates returned for address: "+e.address):e.location=t.coordinates,t.timezone?e.dateTime=u(e.dateTime,t.timezone.id):console.log("Invalid timezone returned for coordinates: "+e.address+" "+JSON.stringify(e.location)),delete e.address})}).then(function(){e(r)}).catch(i)}):new Promise(function(e,t){t(new Error("Your server is not running a version that supports WEX Customer files. The minimum version is 5.7.1606.0 this server is "+L+"."))});var e},E=function(o,t){return new Promise(function(e){var r=[];return t.forEach(function(t){var e,n={};Object.keys(o).forEach(function(e){n[o[e].replace(m,"")]=t[e]}),t.hasOwnProperty("ColumnM")&&((e=new k(f(t.ColumnA),f(t.ColumnB),f(t.ColumnC),f(t.ColumnD),f(t.ColumnE),g(t.ColumnF),p(t.ColumnG),p(t.ColumnJ),p(t.ColumnH),f(t.ColumnI),{x:p(t.ColumnK),y:p(t.ColumnL)},"Unknown",f(t.ColumnM),JSON.stringify(n),function(e){switch(e.toLowerCase().replace(" ","")){case"nonfuel":return"NonFuel";case"regular":return"Regular";case"midgrade":return"Midgrade";case"premium":return"Premium";case"super":return"Super";case"diesel":return"Diesel";case"e85":return"E85";case"cng":return"CNG";case"lpg":return"LPG";default:return"Unknown"}}(f(t.ColumnN)))).fleet=f(b),r.push(e))}),e(r)})};return this.parse=function(e){var t,n,r,o,a,i=(n=(t=e)[0],r=!0,Object.keys(n).forEach(function(e){isNaN(parseInt(e,10))||(r=!1)}),r?t.shift():[]);return i?(o="VIN"===(a=i).ColumnA&&"Driver Name"===a.ColumnM?l:"Fleet Name"===f(a.ColumnA)&&"ACCOUNT NUMBER 5"===f(a.ColumnB)?c:"Card Number"===f(a.ColumnA)&&"Vehicle Card Department"===f(a.ColumnB)?u:s)===s?new Promise(function(e,t){t(new Error("unrecognised file provider"))}):function(e,t,n){switch(e){case c:return d(t,n);case u:return v(t,n);case l:return E(t,n);default:return null}}(o,i,e):new Promise(function(e,t){t(new Error("missing row headings in file"))})},this},x=function(e){var t,n,r,o,a,i=new B;c.value=null,u.value="",(n=e).target&&0<n.target.responseText.length?(r=JSON.parse(n.target.responseText)).error?a=r.error:o=r.result:a={message:"No data"},(t={error:a,data:o}).error?D(g,t.error.message):i.parse(t.data).then(function(e){var t,n;null!==(E=e)?E.length?(n={},E.forEach(function(e){n[e.fleet]=e.fleet||b}),t=Object.keys(n),U(),t.sort(),t.forEach(function(e){var t=document.createElement("OPTION");t.textContent=e,t.value=e,d.appendChild(t)}),0<t.length&&S(!0),A(!0),T(),D()):D(g,"No transactions found in file"):D(g,"Can not determine file provider type, try converting to MyGeotab file type")}).catch(function(e){D(g,"Error parsing file: "+(e.message||e))})},t=function(e){e.preventDefault(),D(N,"Parsing... transferring file"),y.getSession(function(e){var t,n,r,o,a,i,s=JSON.stringify({id:-1,method:"ExcelToJson",params:{minColumnsAmount:28,credentials:e}});window.FormData?(t=new FormData,n=new XMLHttpRequest,t.append("JSON-RPC",s),t.append("fileToUpload",c.files[0]),n.upload.addEventListener("progress",M,!1),n.addEventListener("load",x,!1),n.addEventListener("error",R,!1),n.addEventListener("abort",R,!1),n.open("POST",O()),n.send(t)):(r=C,o=O(),a=s,i=document.createElement("iframe"),r.querySelector('input[type="hidden"]').value=a,i.setAttribute("id","upload_iframe"),i.setAttribute("name","upload_iframe"),i.setAttribute("width","0"),i.setAttribute("height","0"),i.setAttribute("border","0"),i.setAttribute("style","width: 0; height: 0; border: none;"),r.parentNode.appendChild(i),window.frames.upload_iframe.name="upload_iframe",i.addEventListener("load",function e(t){var n;t.preventDefault(),t.stopPropagation(),i.removeEventListener("load",e,!1),i.contentDocument?n=i.contentDocument.body.innerHTML:i.contentWindow?n=i.contentWindow.document.body.innerHTML:i.document&&(n=i.document.body.innerHTML),x({target:{responseText:n}}),setTimeout(function(){i.parentNode.removeChild(i)},250)},!0),r.setAttribute("target","upload_iframe"),r.setAttribute("action",o),r.setAttribute("method","post"),r.setAttribute("enctype","multipart/form-data"),r.setAttribute("encoding","multipart/form-data"),r.submit()),b=e.database,w(!1)})},M=function(e){if(e.lengthComputable){var t=Math.round(100*e.loaded/e.tota);D(N,t<100?"Parsing: transferring file "+t.toString()+"%":"Parsing: converting csv to fuel transactions")}},R=function(){D(g,"There was an error attempting to upload the file.")},G=function(){var e,t,n=d.options[d.selectedIndex].value,r=[],o=[],a=0,i=0,s="Importing fuel transactions...",c=function(e){a+="string"==typeof e?1:e.length},u=function(n){return new Promise(function(e,t){y.multiCall(n,e,t)})},l=function(){var t=r.pop();return function(e){return c(e),D(N,s+" "+a+"/"+i),u(t)}};for(A(!1),P(!1),D(N,s),E.forEach(function(e,t){n&&e.fleet!==n||(o.push(["Add",{typeName:"FuelTransaction",entity:e}]),i++),100!==o.length&&t!==E.length-1||(r.push(o),o=[])}),e=u(r.pop()),t=0;t<r.length;t++)e=e.then(l()),t--;e.then(function(e){c(e),I(),D(p,a),P(!0)}).catch(function(e){P(!0),D(g,e.toString())})},F=function(e){var t=e.target.checked;t?e.target.parentNode.className+=" active":e.target.parentNode.className=e.target.parentNode.className.replace("active",""),h.style.display=t?"block":"none"};return{initialize:function(e,t,n){y=e,r=document.getElementById("importFuelTransactions"),c=document.getElementById("files"),o=document.getElementById("parseButton"),a=document.getElementById("importButton"),i=document.getElementById("cancelButton"),d=document.getElementById("fleet"),s=document.getElementById("exampleButton"),u=document.getElementById("fileName"),l=document.getElementById("transactionList"),m=document.getElementById("transactionContainer"),f=document.getElementById("fileSelectContainer"),N=document.getElementById("alertInfo"),p=document.getElementById("alertSuccess"),g=document.getElementById("alertError"),h=document.getElementById("sample"),C=document.getElementById("form"),v=document.getElementById("listCount"),y.call("GetVersion",{},function(e){L=e,n()},function(e){D(g,e.toString()),n()})},focus:function(){c.addEventListener("change",e,!1),o.addEventListener("click",t,!1),a.addEventListener("click",G,!1),d.addEventListener("change",T,!1),s.addEventListener("change",F,!1),i.addEventListener("click",I,!1),r.style.display="block"},blur:function(){c.removeEventListener("change",e,!1),o.removeEventListener("click",t,!1),a.removeEventListener("click",G,!1),d.removeEventListener("change",T,!1),s.removeEventListener("change",F,!1),i.removeEventListener("click",I,!1)}}};